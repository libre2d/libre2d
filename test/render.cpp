/* SPDX-License-Identifier: GPL-3.0-or-later */
/*
 * Copyright (C) 2021, Paul Elder
 *
 * render.cpp - Basic rendering test
 */

#include <libre2d/component.h>
#include <libre2d/geometry.h>
#include <libre2d/model.h>

#include <GL/glew.h>
#include <GL/glut.h>

#include <fstream>
#include <iostream>
#include <sstream>
#include <string>
#include <vector>

using namespace libre2d;

Model model_;

std::vector<Vertex> mouthVertices = {
	Vertex(-0.17241, -0.46835, 0.0),
	Vertex(-0.24138, -0.48101, 0.0),
	Vertex(-0.11724, -0.48101, 0.0),
	Vertex(-0.06207, -0.48101, 0.0),
	Vertex( 0.00690, -0.50633, 0.0),
	Vertex(-0.17241, -0.51899, 0.0),
	Vertex(-0.07586, -0.53165, 0.0),
	Vertex(-0.22759, -0.54430, 0.0),
	Vertex(-0.15862, -0.56962, 0.0),
	Vertex(-0.08966, -0.56962, 0.0),
	Vertex(-0.02069, -0.56962, 0.0),
};

std::vector<std::array<unsigned int, 3>> mouthPlanes = {
	{0, 5, 1},
	{0, 2, 5},
	{2, 3, 6},
	{3, 4, 6},
	{2, 6, 5},
	{1, 5, 7},
	{5, 8, 7},
	{5, 9, 8},
	{6, 9, 5},
	{6, 10, 9},
	{4, 10, 6},
};

std::vector<UV> mouthUVMap = {
	UV(0.47126, 0.36709),
	UV(0.45977, 0.37025),
	UV(0.48046, 0.37025),
	UV(0.48966, 0.37025),
	UV(0.50115, 0.37658),
	UV(0.47126, 0.37975),
	UV(0.48736, 0.38291),
	UV(0.46207, 0.38608),
	UV(0.47356, 0.39241),
	UV(0.48506, 0.39241),
	UV(0.49655, 0.39241),
};

std::vector<Vertex> faceVertices = {
	Vertex(-0.13103, 0.53165, 0.0),
	Vertex(-0.00690, 0.53165, 0.0),
	Vertex(-0.25517, 0.49367, 0.0),
	Vertex(0.10345, 0.48101, 0.0),
	Vertex(-0.32414, 0.44304, 0.0),
	Vertex(0.20000, 0.43038, 0.0),
	Vertex(-0.43448, 0.36709, 0.0),
	Vertex(0.28276, 0.35443, 0.0),
	Vertex(-0.08966, 0.34177, 0.0),
	Vertex(-0.25517, 0.31646, 0.0),
	Vertex(0.07586, 0.30380, 0.0),
	Vertex(-0.48966, 0.27848, 0.0),
	Vertex(0.36552, 0.25316, 0.0),
	Vertex(-0.36552, 0.22785, 0.0),
	Vertex(0.15862, 0.21519, 0.0),
	Vertex(-0.55862, 0.20253, 0.0),
	Vertex(-0.22759, 0.13924, 0.0),
	Vertex(-0.00690, 0.13924, 0.0),
	Vertex(0.42069, 0.11392, 0.0),
	Vertex(-0.62759, 0.10127, 0.0),
	Vertex(0.28276, 0.10127, 0.0),
	Vertex(-0.51724, 0.08861, 0.0),
	Vertex(-0.32414, 0.05063, 0.0),
	Vertex(0.11724, 0.03797, 0.0),
	Vertex(-0.11724, 0.01266, 0.0),
	Vertex(-0.66897, 0.00000, 0.0),
	Vertex(0.35172, -0.01266, 0.0),
	Vertex(-0.58621, -0.02532, 0.0),
	Vertex(0.42069, -0.03797, 0.0),
	Vertex(-0.40690, -0.07595, 0.0),
	Vertex(-0.68276, -0.08861, 0.0),
	Vertex(0.21379, -0.10127, 0.0),
	Vertex(-0.22759, -0.11392, 0.0),
	Vertex(0.00690, -0.12658, 0.0),
	Vertex(0.33793, -0.12658, 0.0),
	Vertex(-0.60000, -0.15190, 0.0),
	Vertex(-0.48966, -0.16456, 0.0),
	Vertex(0.40690, -0.16456, 0.0),
	Vertex(-0.68276, -0.17722, 0.0),
	Vertex(-0.33793, -0.20253, 0.0),
	Vertex(-0.10345, -0.21519, 0.0),
	Vertex(0.13103, -0.22785, 0.0),
	Vertex(-0.57241, -0.24051, 0.0),
	Vertex(0.29655, -0.25316, 0.0),
	Vertex(-0.43448, -0.27848, 0.0),
	Vertex(0.39310, -0.27848, 0.0),
	Vertex(-0.68276, -0.29114, 0.0),
	Vertex(-0.53103, -0.32911, 0.0),
	Vertex(0.10345, -0.32911, 0.0),
	Vertex(-0.33793, -0.34177, 0.0),
	Vertex(-0.00690, -0.34177, 0.0),
	Vertex(-0.65517, -0.35443, 0.0),
	Vertex(-0.18621, -0.35443, 0.0),
	Vertex(0.22759, -0.39241, 0.0),
	Vertex(0.36552, -0.40506, 0.0),
	Vertex(-0.46207, -0.41772, 0.0),
	Vertex(-0.62759, -0.43038, 0.0),
	Vertex(0.00690, -0.44304, 0.0),
	Vertex(-0.21379, -0.45570, 0.0),
	Vertex(0.13103, -0.48101, 0.0),
	Vertex(-0.39310, -0.49367, 0.0),
	Vertex(-0.08966, -0.49367, 0.0),
	Vertex(-0.57241, -0.50633, 0.0),
	Vertex(0.31034, -0.50633, 0.0),
	Vertex(0.04828, -0.54430, 0.0),
	Vertex(-0.48966, -0.55696, 0.0),
	Vertex(-0.29655, -0.58228, 0.0),
	Vertex(0.24138, -0.58228, 0.0),
	Vertex(-0.04828, -0.59494, 0.0),
	Vertex(-0.40690, -0.62025, 0.0),
	Vertex(-0.15862, -0.63291, 0.0),
	Vertex(0.14483, -0.64557, 0.0),
	Vertex(-0.35172, -0.67089, 0.0),
	Vertex(0.06207, -0.69620, 0.0),
	Vertex(-0.26897, -0.72152, 0.0),
	Vertex(-0.00690, -0.72152, 0.0),
	Vertex(-0.18621, -0.75949, 0.0),
	Vertex(-0.08966, -0.75949, 0.0),
};

std::vector<UV> faceUVMap = {
	UV(0.14483, 0.11709),
	UV(0.16552, 0.11709),
	UV(0.12414, 0.12658),
	UV(0.18391, 0.12975),
	UV(0.11264, 0.13924),
	UV(0.20000, 0.14241),
	UV(0.09425, 0.15823),
	UV(0.21379, 0.16139),
	UV(0.15172, 0.16456),
	UV(0.12414, 0.17089),
	UV(0.17931, 0.17405),
	UV(0.08506, 0.18038),
	UV(0.22759, 0.18671),
	UV(0.10575, 0.19304),
	UV(0.19310, 0.19620),
	UV(0.07356, 0.19937),
	UV(0.12874, 0.21519),
	UV(0.16552, 0.21519),
	UV(0.23678, 0.22152),
	UV(0.06207, 0.22468),
	UV(0.21379, 0.22468),
	UV(0.08046, 0.22785),
	UV(0.11264, 0.23734),
	UV(0.18621, 0.24051),
	UV(0.14713, 0.24684),
	UV(0.05517, 0.25000),
	UV(0.22529, 0.25316),
	UV(0.06897, 0.25633),
	UV(0.23678, 0.25949),
	UV(0.09885, 0.26899),
	UV(0.05287, 0.27215),
	UV(0.20230, 0.27532),
	UV(0.12874, 0.27848),
	UV(0.16782, 0.28165),
	UV(0.22299, 0.28165),
	UV(0.06667, 0.28797),
	UV(0.08506, 0.29114),
	UV(0.23448, 0.29114),
	UV(0.05287, 0.29430),
	UV(0.11034, 0.30063),
	UV(0.14943, 0.30380),
	UV(0.18851, 0.30696),
	UV(0.07126, 0.31013),
	UV(0.21609, 0.31329),
	UV(0.09425, 0.31962),
	UV(0.23218, 0.31962),
	UV(0.05287, 0.32278),
	UV(0.07816, 0.33228),
	UV(0.18391, 0.33228),
	UV(0.11034, 0.33544),
	UV(0.16552, 0.33544),
	UV(0.05747, 0.33861),
	UV(0.13563, 0.33861),
	UV(0.20460, 0.34810),
	UV(0.22759, 0.35127),
	UV(0.08966, 0.35443),
	UV(0.06207, 0.35759),
	UV(0.16782, 0.36076),
	UV(0.13103, 0.36392),
	UV(0.18851, 0.37025),
	UV(0.10115, 0.37342),
	UV(0.15172, 0.37342),
	UV(0.07126, 0.37658),
	UV(0.21839, 0.37658),
	UV(0.17471, 0.38608),
	UV(0.08506, 0.38924),
	UV(0.11724, 0.39557),
	UV(0.20690, 0.39557),
	UV(0.15862, 0.39873),
	UV(0.09885, 0.40506),
	UV(0.14023, 0.40823),
	UV(0.19080, 0.41139),
	UV(0.10805, 0.41772),
	UV(0.17701, 0.42405),
	UV(0.12184, 0.43038),
	UV(0.16552, 0.43038),
	UV(0.13563, 0.43987),
	UV(0.15172, 0.43987),
};

std::vector<std::array<unsigned int, 3>> facePlanes = {
	{ 0,  1,  8},
	{ 1,  3,  8},
	{ 3,  5, 10},
	{ 3, 10,  8},
	{ 5,  7, 10},
	{ 7, 14, 10},
	{ 7, 12, 14},
	{12, 20, 14},
	{12, 18, 20},
	{18, 26, 20},
	{18, 28, 26},
	{28, 34, 26},
	{28, 37, 34},
	{34, 37, 43},
	{37, 45, 43},
	{45, 53, 43},
	{45, 54, 53},
	{54, 63, 53},
	{63, 67, 53},
	{67, 59, 53},
	{67, 71, 59},
	{71, 73, 59},
	{73, 64, 59},
	{73, 75, 64},
	{75, 68, 64},
	{75, 77, 68},
	{77, 70, 68},
	{77, 76, 70},
	{76, 74, 70},
	{74, 72, 70},
	{72, 66, 70},
	{72, 69, 66},
	{69, 65, 66},
	{65, 60, 66},
	{65, 62, 60},
	{62, 55, 60},
	{62, 56, 55},
	{56, 51, 55},
	{51, 46, 47},
	{46, 42, 47},
	{46, 38, 42},
	{38, 35, 42},
	{38, 30, 35},
	{30, 27, 35},
	{30, 25, 27},
	{25, 19, 27},
	{19, 21, 27},
	{19, 15, 21},
	{15, 11, 21},
	{11, 13, 21},
	{11,  6, 13},
	{ 6,  4, 13},
	{ 4,  2,  9},
	{ 4,  9, 13},
	{ 2,  0,  9},
	{ 0,  8,  9},

	{10, 14, 17},
	{14, 23, 17},
	{14, 20, 23},
	{20, 31, 23},
	{20, 26, 31},
	{26, 34, 31},
	{31, 34, 43},
	{31, 43, 41},
	{41, 43, 53},
	{48, 53, 59},
	{41, 53, 48},
	{59, 64, 57},
	{48, 59, 57},
	{57, 64, 68},
	{61, 68, 70},
	{57, 68, 61},
	{61, 70, 66},
	{61, 66, 58},
	{58, 66, 60},
	{49, 58, 60},
	{49, 60, 55},
	{44, 49, 55},
	{44, 55, 47},
	{35, 36, 42},
	{42, 44, 47},
	{36, 44, 42},
	{27, 36, 35},
	{29, 36, 27},
	{21, 29, 27},
	{21, 22, 29},
	{13, 22, 21},
	{13, 16, 22},
	{ 9, 16, 13},
	{ 9,  8, 16},
	{16, 17,  8},
	{ 8, 10, 17},

	{16, 17, 24},
	{17, 23, 24},
	{24, 23, 33},
	{23, 31, 33},
	{33, 31, 41},
	{50, 48, 57},
	{16, 22, 24},
	{22, 24, 32},
	{24, 33, 32},
	{22, 32, 29},
	{29, 39, 36},
	{36, 39, 44},
	{39, 49, 44},
	{49, 52, 58},
	{39, 52, 49},
	{29, 32, 39},
	{32, 33, 40},
	{33, 41, 50},
	{32, 52, 39},
	{32, 40, 52},
	{50, 57, 61},
	{52, 61, 58},
	{52, 50, 61},
	{40, 50, 52},
	{33, 50, 40},
	{41, 48, 50},
};

std::vector<Vertex> leftEyeVertices = {
	Vertex(-0.39310, 0.05063, 0.0),
	Vertex(-0.29655, 0.05063, 0.0),
	Vertex(-0.48966, 0.02532, 0.0),
	Vertex(-0.20000, 0.02532, 0.0),
	Vertex(-0.55862, -0.01266, 0.0),
	Vertex(-0.40690, -0.05063, 0.0),
	Vertex(-0.29655, -0.05063, 0.0),
	Vertex(-0.61379, -0.07595, 0.0),
	Vertex(-0.50345, -0.07595, 0.0),
	Vertex(-0.21379, -0.07595, 0.0),
	Vertex(-0.43448, -0.13924, 0.0),
	Vertex(-0.35172, -0.13924, 0.0),
	Vertex(-0.24138, -0.15190, 0.0),
	Vertex(-0.54483, -0.16456, 0.0),
	Vertex(-0.47586, -0.20253, 0.0),
	Vertex(-0.28276, -0.20253, 0.0),
	Vertex(-0.39310, -0.22785, 0.0),
};

std::vector<std::array<unsigned int, 3>> leftEyePlanes = {
	{ 1,  3,  6},
	{ 3,  9,  6},
	{ 9, 12,  6},
	{12, 15, 11},
	{ 6, 12, 11},
	{11, 15, 16},
	{10, 16, 14},
	{10, 11, 16},
	{ 7,  8, 13},
	{19, 14, 13},
	{ 8, 10, 13},
	{ 4,  8,  7},
	{ 2,  5,  4},
	{ 4,  5,  8},
	{ 0,  5,  2},
	{ 1,  6,  0},
	{ 0,  6,  5},
	{ 5,  6, 11},
	{ 5, 11, 10},
	{ 5, 10,  8},
};

std::vector<UV> leftEyeUVMap = {
	UV(0.10115, 0.73734),
	UV(0.11724, 0.73734),
	UV(0.08506, 0.74367),
	UV(0.13333, 0.74367),
	UV(0.07356, 0.75316),
	UV(0.09885, 0.76266),
	UV(0.11724, 0.76266),
	UV(0.06437, 0.76899),
	UV(0.08276, 0.76899),
	UV(0.13103, 0.76899),
	UV(0.09425, 0.78481),
	UV(0.10805, 0.78481),
	UV(0.12644, 0.78797),
	UV(0.07586, 0.79114),
	UV(0.08736, 0.80063),
	UV(0.11954, 0.80063),
	UV(0.10115, 0.80696),
};

std::vector<Vertex> rightEyeVertices = {
	Vertex(0.20000, -0.01266, 0.0),
	Vertex(0.26897, -0.01266, 0.0),
	Vertex(0.36552, -0.02532, 0.0),
	Vertex(0.11724, -0.05063, 0.0),
	Vertex(0.43448, -0.06329, 0.0),
	Vertex(0.24138, -0.08861, 0.0),
	Vertex(0.15862, -0.10127, 0.0),
	Vertex(0.33793, -0.10127, 0.0),
	Vertex(0.10345, -0.11392, 0.0),
	Vertex(0.42069, -0.12658, 0.0),
	Vertex(0.20000, -0.15190, 0.0),
	Vertex(0.31034, -0.15190, 0.0),
	Vertex(0.08966, -0.17722, 0.0),
	Vertex(0.37931, -0.18987, 0.0),
	Vertex(0.25517, -0.20253, 0.0),
	Vertex(0.17241, -0.22785, 0.0),
	Vertex(0.32414, -0.24051, 0.0),
	Vertex(0.08966, -0.27848, 0.0),
	Vertex(0.25517, -0.27848, 0.0),
	Vertex(0.17241, -0.31646, 0.0),
};

std::vector<std::array<unsigned int, 3>> rightEyePlanes = {
	{ 0,  1,  5},
	{ 1,  2,  5},
	{ 2,  7,  5},
	{ 2,  4,  7},
	{ 4,  9,  7},
	{ 9, 13, 11},
	{ 7,  9, 11},
	{14, 16, 18},
	{15, 18, 19},
	{15, 19, 17},
	{14, 13, 16},
	{11, 13, 14},
	{14, 18, 15},
	{12, 15, 17},
	{ 0,  6,  3},
	{ 3,  6,  8},
	{ 8, 10, 12},
	{10, 15, 12},
	{ 6, 10,  8},
	{ 0,  5,  6},
	{ 6,  5, 10},
	{10, 14, 15},
	{10, 11, 14},
	{ 5, 11, 10},
	{ 5,  7, 11},
};

std::vector<UV> rightEyeUVMap = {
	UV(0.53333, 0.75316),
	UV(0.54483, 0.75316),
	UV(0.56092, 0.75633),
	UV(0.51954, 0.76266),
	UV(0.57241, 0.76582),
	UV(0.54023, 0.77215),
	UV(0.52644, 0.77532),
	UV(0.55632, 0.77532),
	UV(0.51724, 0.77848),
	UV(0.57011, 0.78165),
	UV(0.53333, 0.78797),
	UV(0.55172, 0.78797),
	UV(0.51494, 0.79430),
	UV(0.56322, 0.79747),
	UV(0.54253, 0.80063),
	UV(0.52874, 0.80696),
	UV(0.55402, 0.81013),
	UV(0.51494, 0.81962),
	UV(0.54253, 0.81962),
	UV(0.52874, 0.82911),
};

void createModel()
{
	/*
	 * Skip center because we don't have transformations yet, and skip
	 * anchors since we don't have child meshes yet. But we do need planes
	 * for rendering.
	 */
	Mesh mouthMesh(mouthVertices);
	mouthMesh.planes = mouthPlanes;

	Mesh faceMesh(faceVertices);
	faceMesh.planes = facePlanes;

	Mesh leftEyeMesh(leftEyeVertices);
	leftEyeMesh.planes = leftEyePlanes;

	Mesh rightEyeMesh(rightEyeVertices);
	rightEyeMesh.planes = rightEyePlanes;

	Component mouth;
	mouth.currentMesh = mouthMesh;
	mouth.uvMap = mouthUVMap;

	Component leftEye;
	leftEye.currentMesh = leftEyeMesh;
	leftEye.uvMap = leftEyeUVMap;

	Component rightEye;
	rightEye.currentMesh = rightEyeMesh;
	rightEye.uvMap = rightEyeUVMap;

	Component face;
	face.currentMesh = faceMesh;
	face.uvMap = faceUVMap;

	face.children.push_back(mouth);
	face.children.push_back(leftEye);
	face.children.push_back(rightEye);

	model_.root = face;
}

void render()
{
	glClearColor(0.0f, 0.0f, 0.0f, 1.0f);
	glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);

	model_.render();

	glutSwapBuffers();
	glutPostRedisplay();
}

int main(int argc, char **argv)
{
	glutInit(&argc, argv);
	glutInitDisplayMode(GLUT_DOUBLE | GLUT_RGBA);

	glutInitWindowSize(580, 632);
	glutInitWindowPosition(0, 0);
	glutCreateWindow("libre2d - render test");

	GLenum ret = glewInit();
	if (ret != GLEW_OK) {
		std::cerr << "Failed to initialize glew: "
			  << glewGetErrorString(ret) << std::endl;
		return -1;
	}

	Model::init();

	createModel();
	model_.loadTexture(TEST_TEXTURE_DIR "/test/test-face/texture.png");

	glutDisplayFunc(render);
	glutIdleFunc(render);

	glutMainLoop();
}
